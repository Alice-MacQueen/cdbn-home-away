---
title: "Location by Year Weather PCA"
author: "Alice MacQueen"
date: 2020-08-04
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggbiplot)
library(viridis)
library(cowplot)
```

# Load data
```{r}
wea_monthly <- read_rds("../data/Monthly_weather_data_595_location_by_year_values.rds")
wea_bioclim <- read_rds("../data/Weather_data_bioclim_595_location_by_year_values.rds")
load("../data/locations.rda")
```

# Goal

Use weather data that is also available for climate projects to create a principal components space for all locations and years of CDBN phenotypic data.

Then, we'll map yield heritability onto this PC-space, instead of onto a traditional geographic map.

We can then project future climate predictions into this PC space to predict how yield heritability will change at different growing locations under different future climate scenarios.

## Weather Data Creation Info

Website to download the same variables for the future for different climate projections:
https://adaptwest.databasin.org/pages/adaptwest-climatena

You can download ascii files from this webpage, then you can load those into R using the raster package. 

I also add two additional variables for PCA: Dyln and GDD_8C. We could compute both of these for the future data. See more info in the cdbn-home-away/data-raw/Prepare_project_data.Rmd document.

AdaptWest also computes some bioclim variables that aren't relevant to common bean. See more info in the cdbn-home-away/data-raw/Prepare_project_data.Rmd document.

Non-relevant monthly variables are before day 79 (late March) or after day 320 (mid-November), aka in winter, because beans aren't grown then. 

Data citation:

AdaptWest Project. 2015. Gridded current and future climate data for North America at 1km resolution, interpolated using the ClimateNA v5.10 software (T. Wang et al., 2015). Available at adaptwest.databasin.org.

Reference:

Hamann, A., T. Wang, D. L. Spittlehouse, T. Q. Murdock. 2013. A comprehensive, high-resolution  database of historical and projected climate surfaces for western North America. Bulletin of the American Meteorological Society, 94(9): 1307-1309. 

### Monthly variables I use from this dataset:

    Tmin: minimum temperature for a given month (°C)
    Tmax: maximum temperature for a given month (°C)
    Tave: mean temperature for a given month (°C)
    Ppt:  total precipitation for a given month (mm)

### Monthly variables I use in addition to this dataset:

    Dyln: mean daylength for a given month (hrs - I added, consistent for sites)
    GDD_8C: cumulative GDD at 8C for a given month (I added, we could compute for future just like DD5 below)

### Bioclimatic variables I use from this dataset:

    MAT:  mean annual temperature (°C)
    MWMT: mean temperature of the warmest month (°C)
    MAP:  mean annual precipitation (mm)
    MSP:  mean summer (May to Sep) precipitation (mm) months 5 - 9
    AHM:  annual heat moisture index, calculated as (MAT+10)/(MAP/1000)
    SHM:  summer heat moisture index, calculated as MWMT/(MSP/1000)
    DD5: degree-days above 5°C (growing degree days)
    DD_18: degree-days below 18°C
    DD18: degree-days above 18°C
    Tave_sm: summer (Jun to Aug) mean temperature (°C) months 6 - 8
    PPT_sm:  summer (Jun to Aug) precipitation (mm) months 6 - 8

# ---------------------
# PCA analysis
```{r}
wea_df <- wea_bioclim %>%
  full_join(wea_monthly) %>%
  select(Location_code:PPT_sm, Tmin_04:GDD_8C_10)

wea_df2 <- wea_df[complete.cases(wea_df),]  %>%
  mutate(SHM = case_when(is.infinite(SHM) ~ 0,
                         TRUE ~ SHM),
         AHM = case_when(is.infinite(AHM) ~ 0,
                         TRUE ~ AHM))
#wea_df3 <- wea_df[!complete.cases(wea_df),]
wea_bioclim2 <- wea_bioclim[complete.cases(wea_bioclim),] %>%
  mutate(SHM = case_when(is.infinite(SHM) ~ 0,
                         TRUE ~ SHM),
         AHM = case_when(is.infinite(AHM) ~ 0,
                         TRUE ~ AHM))

locations <- locations %>%
  mutate(Latbin = floor(Latitude / 10)*10,
         Longbin = floor(Longitue / 10)*10,
         Locbin = paste(Latbin, Longbin, sep = "_"))
unique(locations$Locbin)
```
remove MBMO 1999, WYLI 2007, do PCA on just bioclim variables for 593 L*Y.
Do PCA on bioclim & monthly variables for 567 L*Y. See if you gain anything. 
Looks like you might gain some discriminatory power for PC's 3 and 4 with the monthly weather variables. Daylength and Tmax/Tmin both help some. After that, nothing, though.

```{r}
bioclim_pca <- prcomp(wea_bioclim2[,-(1:2)], center = TRUE, scale. = TRUE)
wea_bioclim2 <- wea_bioclim2 %>% left_join(locations)

weapca <- prcomp(wea_df2[,-(1:2)], center = TRUE, scale. = TRUE)
wea_df2 <- wea_df2 %>% left_join(locations) 

summary(bioclim_pca)
summary(weapca)
save(weapca, file = "../data/Bioclim_and_Monthly_weather_variable_PCA.rda")
save(bioclim_pca, file = "../data/Bioclim_weather_variable_PCA.rda")

ggbiplot(bioclim_pca, choices = c(1,2), alpha = 0.4)
save_plot(filename = "../analysis/weather_PCA/Bioclim_variables_PCA_PC1_PC2.png", plot = last_plot())
ggbiplot(bioclim_pca, choices = c(3,4), alpha = 0.4)
save_plot(filename = "../analysis/weather_PCA/Bioclim_variables_PCA_PC3_PC4.png", plot = last_plot())
ggbiplot(weapca, choices = c(1,2), labels = wea_df2$Location_code)
save_plot(filename = "../analysis/weather_PCA/Monthly_variables_PCA_PC1_PC2_Location_codes.png", plot = last_plot())

bpbc12 <- ggbiplot(bioclim_pca, choices = c(1,2), groups = wea_bioclim2$Locbin, ellipse = TRUE, alpha = 0.4) +#, labels = paste(wea_bioclim2$Location_code, wea_bioclim2$Year))
  scale_color_viridis(discrete = TRUE, direction = -1)
save_plot(filename = "../analysis/weather_PCA/Bioclim_variable_PCA_PC1_PC2_Lat_Long_grouped.png", plot = bpbc12, base_height = 5)
bpmnth12 <- ggbiplot(weapca, choices = c(1,2), groups = wea_df2$Locbin, ellipse = TRUE) +#, labels = paste(wea_bioclim2$Location_code, wea_bioclim2$Year))
  scale_color_viridis(discrete = TRUE, direction = -1)
save_plot(filename = "../analysis/weather_PCA/Monthly_variable_PCA_PC1_PC2_Lat_Long_grouped.png", plot = bpmnth12, base_height = 5)
bpbc34 <- ggbiplot(bioclim_pca, choices = c(3,4), groups = wea_bioclim2$Locbin, ellipse = TRUE) +#, labels = paste(wea_bioclim2$Location_code, wea_bioclim2$Year))
  scale_color_viridis(discrete = TRUE, direction = -1)
save_plot(filename = "../analysis/weather_PCA/Bioclim_variable_PCA_PC3_PC4_Lat_Long_grouped.png", plot = bpbc34, base_height = 5)
bpmnth34 <- ggbiplot(weapca, choices = c(3,4), groups = wea_df2$Locbin, ellipse = TRUE) +#, labels = paste(wea_bioclim2$Location_code, wea_bioclim2$Year))
  scale_color_viridis(discrete = TRUE, direction = -1)
save_plot(filename = "../analysis/weather_PCA/Monthly_variable_PCA_PC3_PC4_Lat_Long_grouped.png", plot = bpmnth34, base_height = 5)
bpb56 <- ggbiplot(bioclim_pca, choices = c(5,6), groups = wea_bioclim2$Locbin, ellipse = TRUE) +#, labels = paste(wea_bioclim2$Location_code, wea_bioclim2$Year))
  scale_color_viridis(discrete = TRUE, direction = -1)
save_plot(filename = "../analysis/weather_PCA/Bioclim_variable_PCA_PC5_PC6_Lat_Long_grouped.png", plot = bpb56, base_height = 5)
bpmnth56 <- ggbiplot(weapca, choices = c(5,6), groups = wea_df2$Locbin, ellipse = TRUE) +#, labels = paste(wea_bioclim2$Location_code, wea_bioclim2$Year))
  scale_color_viridis(discrete = TRUE, direction = -1)
save_plot(filename = "../analysis/weather_PCA/Monthly_variable_PCA_PC5_PC6_Lat_Long_grouped.png", plot = bpmnth56, base_height = 5)

```
IDKI 1982 has outlier weather. Ah. Anomalous precipitation value. I bet that's a typo. 
